<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Neon Pulse Platformer</title>
    <style>
        body {
            margin: 0;
            padding: 0;
            background-color: #050505;
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100vh;
            overflow: hidden;
            font-family: 'Courier New', Courier, monospace;
        }
        canvas {
            box-shadow: 0 0 80px rgba(0, 255, 255, 0.2);
            border: 2px solid #333;
        }
        #ui {
            position: absolute;
            top: 20px;
            color: rgba(255, 255, 255, 0.7);
            text-align: center;
            pointer-events: none;
            text-transform: uppercase;
            letter-spacing: 2px;
            z-index: 10;
            width: 800px;
        }
        #death-counter {
            position: absolute;
            top: 20px;
            left: 0;
            color: #ff073a;
            font-size: 16px;
            padding-left: 20px;
        }
    </style>
</head>
<body>

<div id="ui">
    <div id="death-counter">TOTAL DEATHS: 0</div>
</div>

<canvas id="gameCanvas" width="800" height="600"></canvas>

<script>
    const canvas = document.getElementById('gameCanvas');
    const ctx = canvas.getContext('2d');

    // --- GAME CONFIGURATION AND CONSTANTS ---
    const TILE_SIZE = 40;

    const CONFIG = {
        // Updated Menu Options
        menu: {
            MAIN_OPTIONS: ["PLAY GAME", "CUSTOM LEVELS", "LEVEL EDITOR", "OPTIONS", "EXIT"],
            CUSTOM_OPTIONS: [
                "11. PINBALL PANIC (Dash)", "12. MAZE OF GRAVITY (Anti-Grav)", "13. RHYTHM JUMP (Timed Block)", 
                "14. TOXIC TIME BOMB (Toxic Pool)", "15. THE INFINITE LOOP (Warp Gate)", "16. PRECISION PARKOUR",
                "17. BLOCK CHAIN REACTION", "18. TELEPORTING DASH", "19. THE GAUNTLET", "20. CREATOR'S SIGNATURE"
            ],
            currentSelection: 0
        },
        physics: {
            gravity: 0.8,
            friction: 0.85,
            maxFallSpeed: 10
        },
        colors: {
            player: '#00FFFF',
            platform: '#FFFFFF',
            goal: '#00FF00',
            hazard: '#FF0000',
            background: '#050505',
            // New Asset Colors
            dashBoost: '#FFA500', // Orange
            antiGravity: '#8A2BE2', // BlueViolet
            timedBlock: '#FFFF00', // Yellow
            warpGate: '#FF69B4', // HotPink
            toxicPool: '#00FF7F' // SpringGreen
        },
        // NEW: Asset Definitions (Types used in Level Data)
        ASSETS: {
            // Base types
            START: 1,
            PLATFORM: 2,
            GOAL: 3,
            HAZARD: 4,
            // New Interactive Types (Assists/Mechanics)
            DASH_BOOST: 5,
            ANTI_GRAVITY_SPHERE: 6,
            TIMED_BLOCK_ON: 7, // Visible state
            TIMED_BLOCK_OFF: 8, // Invisible state
            WARP_GATE_A: 9,
            WARP_GATE_B: 10,
            TOXIC_POOL_SURFACE: 11
        }
    };

    // --- GAME STATE AND PLAYER OBJECTS ---
    let gameState = 'MENU';
    let currentLevelIndex = 0;
    let player = {
        x: 0, y: 0, w: 20, h: 20, vx: 0, vy: 0,
        onGround: false,
        menuState: 'MAIN', // 'MAIN', 'LEVEL_SELECT', 'CUSTOM_SELECT', 'LEVEL_EDITOR', 'CONTROLS', 'OPTIONS'
        deaths: 0,
        sessionDeaths: 0,

        // NEW: Player Assist States
        isDashing: false,
        dashTimer: 0,
        antiGravityTimer: 0, // Time remaining for anti-gravity effect
        isAntiGravity: false,
        teleportCooldown: 0
    };
    
    // --- LEVEL DATA (EXTENDED TO 20 LEVELS) ---
    // Level data is simplified to arrays of [x, y, width, height, type, properties]
    let levels = [
        // BASE LEVELS (1-10) - Focus on progressive introduction
        // Level 1: The Foundations
        [[0, 560, 800, 40, CONFIG.ASSETS.PLATFORM], [50, 500, 100, 20, CONFIG.ASSETS.PLATFORM], [700, 100, 20, 20, CONFIG.ASSETS.GOAL], [0, 530, 20, 20, CONFIG.ASSETS.START]],
        // Level 2: Simple Jumps
        [[0, 560, 800, 40, CONFIG.ASSETS.PLATFORM], [200, 460, 100, 20, CONFIG.ASSETS.PLATFORM], [500, 360, 100, 20, CONFIG.ASSETS.PLATFORM], [700, 100, 20, 20, CONFIG.ASSETS.GOAL], [0, 530, 20, 20, CONFIG.ASSETS.START]],
        // Level 3: Simple Hazards
        [[0, 560, 800, 40, CONFIG.ASSETS.PLATFORM], [200, 520, 100, 40, CONFIG.ASSETS.HAZARD], [700, 100, 20, 20, CONFIG.ASSETS.GOAL], [0, 530, 20, 20, CONFIG.ASSETS.START]],
        // Level 4: Longer Gaps
        [[0, 560, 150, 40, CONFIG.ASSETS.PLATFORM], [300, 560, 150, 40, CONFIG.ASSETS.PLATFORM], [600, 560, 200, 40, CONFIG.ASSETS.PLATFORM], [700, 500, 20, 20, CONFIG.ASSETS.GOAL], [0, 530, 20, 20, CONFIG.ASSETS.START]],
        // Level 5: Vertical Climb
        [[0, 560, 800, 40, CONFIG.ASSETS.PLATFORM], [100, 500, 40, 40, CONFIG.ASSETS.PLATFORM], [200, 440, 40, 40, CONFIG.ASSETS.PLATFORM], [300, 380, 40, 40, CONFIG.ASSETS.PLATFORM], [700, 100, 20, 20, CONFIG.ASSETS.GOAL], [0, 530, 20, 20, CONFIG.ASSETS.START]],
        // Level 6: Hazard Jump
        [[0, 560, 150, 40, CONFIG.ASSETS.PLATFORM], [150, 560, 100, 40, CONFIG.ASSETS.HAZARD], [250, 560, 150, 40, CONFIG.ASSETS.PLATFORM], [700, 500, 20, 20, CONFIG.ASSETS.GOAL], [0, 530, 20, 20, CONFIG.ASSETS.START]],
        // Level 7: More Complex Platforms
        [[0, 560, 800, 40, CONFIG.ASSETS.PLATFORM], [100, 500, 100, 20, CONFIG.ASSETS.PLATFORM], [300, 400, 100, 20, CONFIG.ASSETS.PLATFORM], [500, 300, 100, 20, CONFIG.ASSETS.PLATFORM], [700, 100, 20, 20, CONFIG.ASSETS.GOAL], [0, 530, 20, 20, CONFIG.ASSETS.START]],
        // Level 8: Hazard Path
        [[0, 560, 800, 40, CONFIG.ASSETS.PLATFORM], [100, 520, 50, 40, CONFIG.ASSETS.HAZARD], [250, 520, 50, 40, CONFIG.ASSETS.HAZARD], [400, 520, 50, 40, CONFIG.ASSETS.HAZARD], [700, 100, 20, 20, CONFIG.ASSETS.GOAL], [0, 530, 20, 20, CONFIG.ASSETS.START]],
        // Level 9: Precision Timing
        [[0, 560, 800, 40, CONFIG.ASSETS.PLATFORM], [100, 450, 40, 40, CONFIG.ASSETS.PLATFORM], [300, 350, 40, 40, CONFIG.ASSETS.PLATFORM], [700, 100, 20, 20, CONFIG.ASSETS.GOAL], [0, 530, 20, 20, CONFIG.ASSETS.START]],
        // Level 10: The Grand Test (End of Base Game)
        [[0, 560, 800, 40, CONFIG.ASSETS.PLATFORM], [100, 400, 600, 20, CONFIG.ASSETS.HAZARD], [700, 100, 20, 20, CONFIG.ASSETS.GOAL], [0, 530, 20, 20, CONFIG.ASSETS.START]],

        // CUSTOM LEVELS (11-20) - Focus on new mechanics and complexity
        // Level 11: Pinball Panic (Dash Boost Focus)
        [[0, 560, 800, 40, CONFIG.ASSETS.PLATFORM], [50, 530, 20, 20, CONFIG.ASSETS.START], [200, 500, 20, 20, CONFIG.ASSETS.DASH_BOOST], [400, 400, 20, 20, CONFIG.ASSETS.DASH_BOOST], [700, 100, 20, 20, CONFIG.ASSETS.GOAL]],
        // Level 12: The Maze of Gravity (Anti-Gravity Focus)
        [[0, 560, 800, 40, CONFIG.ASSETS.PLATFORM], [50, 530, 20, 20, CONFIG.ASSETS.START], [200, 500, 20, 20, CONFIG.ASSETS.ANTI_GRAVITY_SPHERE], [400, 300, 20, 20, CONFIG.ASSETS.ANTI_GRAVITY_SPHERE], [700, 100, 20, 20, CONFIG.ASSETS.GOAL]],
        // Level 13: Rhythm Jump (Timed Block Focus)
        [[0, 560, 800, 40, CONFIG.ASSETS.PLATFORM], [50, 530, 20, 20, CONFIG.ASSETS.START], 
        // Timed blocks with different initial states/cycles will be defined here by the Level Editor
        [200, 500, 80, 20, CONFIG.ASSETS.TIMED_BLOCK_ON, {cycle: 2, offset: 0}], 
        [400, 400, 80, 20, CONFIG.ASSETS.TIMED_BLOCK_OFF, {cycle: 2, offset: 1}],
        [700, 100, 20, 20, CONFIG.ASSETS.GOAL]],
        // Level 14: Toxic Time Bomb (Toxic Pool Focus)
        [[0, 560, 800, 40, CONFIG.ASSETS.PLATFORM], [50, 530, 20, 20, CONFIG.ASSETS.START], 
        [0, 580, 800, 20, CONFIG.ASSETS.TOXIC_POOL_SURFACE], // Rising hazard logic is complex, simulated as static for now
        [700, 100, 20, 20, CONFIG.ASSETS.GOAL]],
        // Level 15: The Infinite Loop (Warp Gate Focus)
        [[0, 560, 800, 40, CONFIG.ASSETS.PLATFORM], [50, 530, 20, 20, CONFIG.ASSETS.START], 
        [200, 500, 40, 60, CONFIG.ASSETS.WARP_GATE_A, {linkID: 100}], 
        [600, 500, 40, 60, CONFIG.ASSETS.WARP_GATE_B, {linkID: 99}], // Gates link back and forth (99->100, 100->99)
        [700, 100, 20, 20, CONFIG.ASSETS.GOAL]],
        // Level 16: Precision Parkour
        [[0, 560, 800, 40, CONFIG.ASSETS.PLATFORM], [50, 530, 20, 20, CONFIG.ASSETS.START], [700, 100, 20, 20, CONFIG.ASSETS.GOAL]],
        // Level 17: Block Chain Reaction
        [[0, 560, 800, 40, CONFIG.ASSETS.PLATFORM], [50, 530, 20, 20, CONFIG.ASSETS.START], [700, 100, 20, 20, CONFIG.ASSETS.GOAL]],
        // Level 18: Teleporting Dash
        [[0, 560, 800, 40, CONFIG.ASSETS.PLATFORM], [50, 530, 20, 20, CONFIG.ASSETS.START], [700, 100, 20, 20, CONFIG.ASSETS.GOAL]],
        // Level 19: The Gauntlet
        [[0, 560, 800, 40, CONFIG.ASSETS.PLATFORM], [50, 530, 20, 20, CONFIG.ASSETS.START], [700, 100, 20, 20, CONFIG.ASSETS.GOAL]],
        // Level 20: Creator's Signature (Mastery)
        [[0, 560, 800, 40, CONFIG.ASSETS.PLATFORM], [50, 530, 20, 20, CONFIG.ASSETS.START], [700, 100, 20, 20, CONFIG.ASSETS.GOAL]]
    ];

    // --- UTILITY FUNCTIONS (MINIMAL IMPLEMENTATIONS ADDED TO PREVENT ERRORS) ---

    function drawRect(x, y, w, h, color) {
        ctx.fillStyle = color;
        ctx.fillRect(x, y, w, h);
    }

    function drawText(text, x, y, size, color, align = 'left', glowColor = 'transparent', glowBlur = 0) {
        ctx.save();
        ctx.shadowColor = glowColor;
        ctx.shadowBlur = glowBlur;
        ctx.font = `${size}px 'Courier New', Courier, monospace`;
        ctx.fillStyle = color;
        ctx.textAlign = align;
        ctx.fillText(text, x, y);
        ctx.restore();
    }

    function resetLevel() {
        const currentLevel = levels[currentLevelIndex];
        let startBlock = currentLevel.find(block => block[4] === CONFIG.ASSETS.START);
        if (startBlock) {
            player.x = startBlock[0];
            player.y = startBlock[1];
        } else {
            // Default reset if start not found
            player.x = 50;
            player.y = 500;
        }
        player.vx = 0;
        player.vy = 0;
        player.isDashing = false;
        player.isAntiGravity = false;
    }

    function nextLevel() {
        if (currentLevelIndex < levels.length - 1) {
            currentLevelIndex++;
        }
        player.sessionDeaths = 0;
        resetLevel();
        gameState = 'PLAYING';
    }

    // --- DRAWING FUNCTIONS (UPDATED/NEW) ---

    // Function to draw the current level blocks (required for drawPlaying)
    function drawLevel(level) {
        level.forEach(block => {
            const [x, y, w, h, type] = block;
            let color = CONFIG.colors.platform;
            let glow = CONFIG.colors.platform;
            let drawGlow = 5;

            switch (type) {
                case CONFIG.ASSETS.START: color = CONFIG.colors.player; glow = CONFIG.colors.player; break;
                case CONFIG.ASSETS.GOAL: color = CONFIG.colors.goal; glow = CONFIG.colors.goal; break;
                case CONFIG.ASSETS.HAZARD: color = CONFIG.colors.hazard; glow = CONFIG.colors.hazard; drawGlow = 10; break;
                case CONFIG.ASSETS.DASH_BOOST: color = CONFIG.colors.dashBoost; glow = CONFIG.colors.dashBoost; break;
                case CONFIG.ASSETS.ANTI_GRAVITY_SPHERE: color = CONFIG.colors.antiGravity; glow = CONFIG.colors.antiGravity; break;
                case CONFIG.ASSETS.TIMED_BLOCK_ON: 
                case CONFIG.ASSETS.TIMED_BLOCK_OFF: 
                    // Visibility logic should go here based on time/properties
                    color = CONFIG.colors.timedBlock; glow = CONFIG.colors.timedBlock;
                    break;
                case CONFIG.ASSETS.WARP_GATE_A:
                case CONFIG.ASSETS.WARP_GATE_B:
                    color = CONFIG.colors.warpGate; glow = CONFIG.colors.warpGate;
                    break;
                case CONFIG.ASSETS.TOXIC_POOL_SURFACE:
                    color = CONFIG.colors.toxicPool; glow = CONFIG.colors.toxicPool; drawGlow = 15;
                    break;
                default: color = CONFIG.colors.platform; glow = CONFIG.colors.platform; break;
            }
            
            ctx.save();
            ctx.shadowColor = glow;
            ctx.shadowBlur = drawGlow;
            drawRect(x, y, w, h, color);
            ctx.restore();
        });
    }

    // Function to draw the player (required for drawPlaying)
    function drawPlayer(p) {
        let color = p.isAntiGravity ? CONFIG.colors.antiGravity : CONFIG.colors.player;
        let glow = p.isAntiGravity ? CONFIG.colors.antiGravity : CONFIG.colors.player;
        let glowBlur = p.isDashing ? 25 : 10;
        
        ctx.save();
        ctx.shadowColor = glow;
        ctx.shadowBlur = glowBlur;
        drawRect(p.x, p.y, p.w, p.h, color);
        ctx.restore();
    }

    function drawPlaying() {
        ctx.fillStyle = CONFIG.colors.background;
        ctx.fillRect(0, 0, canvas.width, canvas.height);

        drawLevel(levels[currentLevelIndex]);
        drawPlayer(player);
        
        document.getElementById('death-counter').innerText = `TOTAL DEATHS: ${player.deaths}`;

        // Display current level number
        let levelDisplay = currentLevelIndex < 10 ? `LEVEL ${currentLevelIndex + 1}` : `CUSTOM LEVEL ${currentLevelIndex + 1}`;
        drawText(levelDisplay, 400, 50, 24, CONFIG.colors.platform, 'center');

        // Display Anti-Gravity status
        if (player.isAntiGravity) {
            drawText(`ANTI-GRAVITY: ${player.antiGravityTimer.toFixed(1)}s`, 400, 80, 16, CONFIG.colors.antiGravity, 'center');
        }
    }

    function drawMainMenu() {
        ctx.fillStyle = CONFIG.colors.background;
        ctx.fillRect(0, 0, canvas.width, canvas.height);

        drawText("NEON PULSE", 400, 150, 60, CONFIG.colors.player, 'center', CONFIG.colors.player, 50);

        const options = CONFIG.menu.MAIN_OPTIONS;
        const baseY = 280;
        const spacing = 50;

        options.forEach((option, index) => {
            let color = index === CONFIG.menu.currentSelection ? CONFIG.colors.goal : CONFIG.colors.platform;
            let glow = index === CONFIG.menu.currentSelection ? CONFIG.colors.goal : 'transparent';
            drawText(option, 400, baseY + index * spacing, 24, color, 'center', glow, 20);
        });

        drawText("PRESS SPACE TO SELECT", 400, 550, 14, CONFIG.colors.platform, 'center');
    }

    function drawLevelSelect() {
        ctx.fillStyle = CONFIG.colors.background;
        ctx.fillRect(0, 0, canvas.width, canvas.height);
        drawText("BASE LEVELS (1-10) - PRESS [Q] TO RETURN", 400, 100, 24, CONFIG.colors.player, 'center');
        // Simplified placeholder for level selection
    }

    function drawControls() {
        ctx.fillStyle = CONFIG.colors.background;
        ctx.fillRect(0, 0, canvas.width, canvas.height);
        drawText("CONTROLS - PRESS [Q] TO RETURN", 400, 100, 24, CONFIG.colors.player, 'center');
        // Simplified placeholder for controls screen
    }

    function drawGoalScreen() {
        ctx.fillStyle = CONFIG.colors.background;
        ctx.fillRect(0, 0, canvas.width, canvas.height);
        drawText("LEVEL CLEARED - PRESS [R] TO CONTINUE", 400, 300, 30, CONFIG.colors.goal, 'center', CONFIG.colors.goal, 30);
    }
    
    // NEW: Draw Custom Levels Browser (Fixed selection bug)
    function drawCustomSelect() {
        ctx.fillStyle = CONFIG.colors.background;
        ctx.fillRect(0, 0, canvas.width, canvas.height);

        drawText("CUSTOM LEVELS (11-20)", 400, 80, 40, CONFIG.colors.warpGate, 'center', CONFIG.colors.warpGate, 30);
        drawText("Difficulty: ⭐ = Standard, ⭐⭐⭐⭐⭐ = Creator's Signature", 400, 120, 14, CONFIG.colors.platform, 'center');

        const options = CONFIG.menu.CUSTOM_OPTIONS;
        const baseY = 180;
        const spacing = 35;

        options.forEach((option, index) => {
            // Fix: Selection index for custom levels must be 0-based for the array, 1-based for the menu
            let isSelected = index === CONFIG.menu.currentSelection; 
            let color = isSelected ? CONFIG.colors.goal : CONFIG.colors.platform;
            let glow = isSelected ? CONFIG.colors.goal : 'transparent';
            
            // Add visual difficulty rating based on level number (11-20)
            const levelNum = index + 11;
            let rating = '';
            if (levelNum >= 16 && levelNum !== 17 && levelNum !== 18) rating = '⭐⭐⭐⭐⭐'; 
            else if (levelNum === 12 || levelNum === 13 || levelNum === 15 || levelNum === 18) rating = '⭐⭐⭐⭐';
            else rating = '⭐⭐⭐';
            
            drawText(`${option} - ${rating}`, 400, baseY + index * spacing, 20, color, 'center', glow, 15);
        });

        drawText("PRESS [Q] TO RETURN TO MAIN MENU", 400, 550, 14, CONFIG.colors.platform, 'center');
    }

    // NEW: Draw Level Editor Interface
    function drawLevelEditor() {
        ctx.fillStyle = CONFIG.colors.background;
        ctx.fillRect(0, 0, canvas.width, canvas.height);

        drawText("LEVEL EDITOR v1.0", 400, 50, 40, CONFIG.colors.player, 'center', CONFIG.colors.player, 30);
        drawText("Select Asset [1-5], Place [Space], Test [T], Save [S], Exit [Q]", 400, 80, 14, CONFIG.colors.platform, 'center');

        // Draw grid
        ctx.strokeStyle = 'rgba(255, 255, 255, 0.1)';
        for (let x = 0; x < canvas.width; x += TILE_SIZE) {
            ctx.beginPath(); ctx.moveTo(x, 0); ctx.lineTo(x, canvas.height); ctx.stroke();
        }
        for (let y = 0; y < canvas.height; y += TILE_SIZE) {
            ctx.beginPath(); ctx.moveTo(0, y); ctx.lineTo(canvas.width, y); ctx.stroke();
        }

        // Draw the asset palette (toolbar)
        const assetOptions = ["P - Platform", "H - Hazard", "1 - Dash Boost", "2 - Anti-Gravity", "3 - Timed Block", "4 - Warp Gate", "5 - Toxic Pool"];
        ctx.fillStyle = 'rgba(50, 50, 50, 0.8)';
        ctx.fillRect(0, 0, 800, 30);
        assetOptions.forEach((asset, i) => {
            drawText(asset, 50 + i * 110, 20, 12, CONFIG.colors.platform);
        });
    }


    // --- INPUT HANDLERS (MINIMAL IMPLEMENTATIONS ADDED) ---
    
    function handleLevelSelectInput(key) { 
        if (key === 'q') player.menuState = 'MAIN';
        // Add navigation/selection logic here
    }

    function handleGoalInput(key) { 
        if (key === 'r') nextLevel();
    }
    
    function handleOptionsInput(key) {
        if (key === 'q') player.menuState = 'MAIN';
    }


    function handleMenuInput(key) {
        const numOptions = CONFIG.menu.MAIN_OPTIONS.length;
        if (key === 'ArrowUp') {
            CONFIG.menu.currentSelection = (CONFIG.menu.currentSelection - 1 + numOptions) % numOptions;
        } else if (key === 'ArrowDown') {
            CONFIG.menu.currentSelection = (CONFIG.menu.currentSelection + 1) % numOptions;
        } else if (key === ' ') {
            const selectedOption = CONFIG.menu.MAIN_OPTIONS[CONFIG.menu.currentSelection];
            if (selectedOption === "PLAY GAME") {
                player.menuState = 'LEVEL_SELECT';
                CONFIG.menu.currentSelection = 0;
            } else if (selectedOption === "CUSTOM LEVELS") {
                player.menuState = 'CUSTOM_SELECT';
                CONFIG.menu.currentSelection = 0; // Start selection at Level 11 (index 0 of CUSTOM_OPTIONS)
            } else if (selectedOption === "LEVEL EDITOR") {
                player.menuState = 'LEVEL_EDITOR';
                // No selection reset needed for editor, but a new level canvas would load
            } else if (selectedOption === "OPTIONS") {
                player.menuState = 'OPTIONS';
                CONFIG.menu.currentSelection = 0;
            } else if (selectedOption === "EXIT") {
                alert("Game Exited (in browser environment)");
            }
        }
    }

    function handleCustomSelectInput(key) {
        const numCustomLevels = CONFIG.menu.CUSTOM_OPTIONS.length;
        if (key === 'ArrowUp') {
            CONFIG.menu.currentSelection = (CONFIG.menu.currentSelection - 1 + numCustomLevels) % numCustomLevels;
        } else if (key === 'ArrowDown') {
            CONFIG.menu.currentSelection = (CONFIG.menu.currentSelection + 1) % numCustomLevels;
        } else if (key === ' ') {
            // Start the selected Custom Level (11-20)
            currentLevelIndex = CONFIG.menu.currentSelection + 10; // 1-10 are base, 11-20 are custom
            gameState = 'PLAYING';
            resetLevel();
        } else if (key === 'q') {
            player.menuState = 'MAIN';
            CONFIG.menu.currentSelection = 1; // Return to 'Custom Levels' option
        }
    }

    function handleEditorInput(key) {
        if (key === 'q') {
            player.menuState = 'MAIN';
            CONFIG.menu.currentSelection = 2; 
        } else if (key === 't') {
            drawText("TESTING MODE ACTIVATED (Not implemented)", 400, 300, 30, CONFIG.colors.goal, 'center');
        } else if (key === 's') {
            drawText("LEVEL SAVED (Not implemented)", 400, 450, 20, CONFIG.colors.goal, 'center');
        } 
    }


    // --- GAME LOGIC (MINIMAL IMPLEMENTATIONS ADDED) ---

    // Simplified updatePlayer for structure completion
    function updatePlayer(dt) {
        // --- Player Assist Logic ---
        if (player.teleportCooldown > 0) player.teleportCooldown -= dt;

        if (player.isAntiGravity) {
            player.antiGravityTimer -= dt;
            if (player.antiGravityTimer <= 0) player.isAntiGravity = false;
            player.vy += -CONFIG.physics.gravity * 0.5; // Reversed gravity
        } else {
            player.vy += CONFIG.physics.gravity; // Normal gravity
        }
        
        // Clamp speed
        player.vy = player.isAntiGravity 
            ? Math.max(-CONFIG.physics.maxFallSpeed, player.vy) 
            : Math.min(CONFIG.physics.maxFallSpeed, player.vy);

        if (player.isDashing) {
            player.dashTimer -= dt;
            if (player.dashTimer <= 0) {
                player.isDashing = false;
                player.vx *= 0.5;
            }
        }
        
        // --- Standard Physics ---
        player.vx *= CONFIG.physics.friction;
        player.x += player.vx;
        player.y += player.vy;
        
        // --- Boundary Check ---
        if (player.y + player.h > canvas.height) { 
            player.deaths++;
            player.sessionDeaths++;
            resetLevel();
        }
    }

    // Simplified checkCollisions for structure completion
    function checkCollisions(player, level) {
        // This is where all the complex collision logic would reside
    }

    // --- GAME LOOP AND STATE ---

    function draw() {
        if (gameState === 'MENU') {
            if (player.menuState === 'MAIN') {
                drawMainMenu();
            } else if (player.menuState === 'LEVEL_SELECT') {
                drawLevelSelect();
            } else if (player.menuState === 'CUSTOM_SELECT') { 
                drawCustomSelect();
            } else if (player.menuState === 'LEVEL_EDITOR') { 
                drawLevelEditor();
            } else if (player.menuState === 'CONTROLS') {
                drawControls();
            } else if (player.menuState === 'OPTIONS') {
                // drawOptions();
            }
        } else if (gameState === 'PLAYING') {
            drawPlaying();
        } else if (gameState === 'GOAL') {
            drawGoalScreen();
        }
        requestAnimationFrame(draw);
    }

    function handleInput(key) {
        if (gameState === 'PLAYING') {
            // Standard Movement logic (left/right/jump) goes here
        } else if (gameState === 'MENU') {
            if (player.menuState === 'MAIN') {
                handleMenuInput(key);
            } else if (player.menuState === 'LEVEL_SELECT') {
                handleLevelSelectInput(key);
            } else if (player.menuState === 'CUSTOM_SELECT') { 
                handleCustomSelectInput(key);
            } else if (player.menuState === 'LEVEL_EDITOR') { 
                handleEditorInput(key);
            } else if (player.menuState === 'OPTIONS') {
                handleOptionsInput(key);
            } else if (player.menuState === 'CONTROLS') {
                if (key === 'q') player.menuState = 'MAIN';
            }
        } else if (gameState === 'GOAL') {
            handleGoalInput(key);
        }
    }


    document.addEventListener('keydown', (e) => {
        handleInput(e.key.toLowerCase());
    });
    
    // Start the game loop
    let lastTime = 0;
    function loop(time) {
        if (!lastTime) lastTime = time;
        const dt = (time - lastTime) / 1000;
        lastTime = time;

        if (gameState === 'PLAYING') {
            updatePlayer(dt);
            checkCollisions(player, levels[currentLevelIndex]);
        }
        
        // Request the next frame for the game logic update
        requestAnimationFrame(loop);
    }

    // Initialize
    resetLevel(); // Set initial player position
    loop(0); // Start the update loop
    draw();  // Start the drawing loop (calls itself via requestAnimationFrame)

</script>
</body>
</html>
