<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Neon Pulse Platformer - Fixed</title>
    <style>
        body { margin: 0; background-color: #050505; display: flex; justify-content: center; align-items: center; height: 100vh; overflow: hidden; font-family: 'Courier New', monospace; }
        canvas { box-shadow: 0 0 80px rgba(0, 255, 255, 0.2); border: 2px solid #333; cursor: crosshair; }
        #ui { position: absolute; top: 20px; color: rgba(255, 255, 255, 0.7); text-align: center; width: 800px; pointer-events: none; }
    </style>
</head>
<body>
<div id="ui"><div id="death-counter">TOTAL DEATHS: 0</div></div>
<canvas id="gameCanvas" width="800" height="600"></canvas>

<script>
    const canvas = document.getElementById('gameCanvas');
    const ctx = canvas.getContext('2d');
    const TILE_SIZE = 40;

    const CONFIG = {
        physics: { gravity: 0.8, friction: 0.85, jump: -12 },
        colors: { player: '#00FFFF', platform: '#FFFFFF', goal: '#00FF00', hazard: '#FF0000', bg: '#050505' },
        menuOptions: ["PLAY GAME", "LEVEL EDITOR", "OPTIONS"],
        assets: { PLATFORM: 2, GOAL: 3, HAZARD: 4 }
    };

    let gameState = 'MENU';
    let currentLevelIndex = 0;
    let selectedEditorAsset = CONFIG.assets.PLATFORM;
    
    let player = { 
        x: 50, y: 500, w: 20, h: 20, vx: 0, vy: 0, 
        menuState: 'MAIN', menuSelection: 0, deaths: 0 
    };

    let levels = [
        [[0, 560, 800, 40, 2], [700, 500, 40, 40, 3]], // Level 1
        [[0, 560, 400, 40, 2], [500, 560, 300, 40, 2], [700, 500, 40, 40, 3]] // Level 2
    ];

    function resetLevel() {
        player.x = 50; player.y = 500;
        player.vx = 0; player.vy = 0;
    }

    // --- INPUT HANDLING (FIXED) ---
    window.addEventListener('keydown', e => {
        const key = e.key;
        if (gameState === 'MENU') {
            if (player.menuState === 'MAIN') {
                if (key === 'ArrowUp') player.menuSelection = (player.menuSelection - 1 + CONFIG.menuOptions.length) % CONFIG.menuOptions.length;
                if (key === 'ArrowDown') player.menuSelection = (player.menuSelection + 1) % CONFIG.menuOptions.length;
                if (key === ' ') {
                    if (player.menuSelection === 0) { gameState = 'PLAYING'; resetLevel(); }
                    else if (player.menuSelection === 1) player.menuState = 'LEVEL_EDITOR';
                }
            } else if (player.menuState === 'LEVEL_EDITOR' && key === 'q') player.menuState = 'MAIN';
        } else if (gameState === 'PLAYING' && key === 'Escape') gameState = 'MENU';
    });

    // --- LEVEL EDITOR PLACEMENT (FIXED) ---
    canvas.addEventListener('mousedown', e => {
        if (gameState === 'MENU' && player.menuState === 'LEVEL_EDITOR') {
            const rect = canvas.getBoundingClientRect();
            const mouseX = Math.floor((e.clientX - rect.left) / TILE_SIZE) * TILE_SIZE;
            const mouseY = Math.floor((e.clientY - rect.top) / TILE_SIZE) * TILE_SIZE;
            
            // Add block to current level
            levels[currentLevelIndex].push([mouseX, mouseY, TILE_SIZE, TILE_SIZE, selectedEditorAsset]);
        }
    });

    // --- RENDER FUNCTIONS ---
    function draw() {
        ctx.fillStyle = CONFIG.colors.bg;
        ctx.fillRect(0, 0, canvas.width, canvas.height);

        if (gameState === 'MENU') {
            if (player.menuState === 'MAIN') {
                ctx.fillStyle = 'white'; ctx.textAlign = 'center'; ctx.font = '40px Courier';
                ctx.fillText("NEON PULSE", 400, 150);
                CONFIG.menuOptions.forEach((opt, i) => {
                    ctx.fillStyle = i === player.menuSelection ? CONFIG.colors.goal : 'white';
                    ctx.fillText(opt, 400, 300 + i * 60);
                });
            } else if (player.menuState === 'LEVEL_EDITOR') {
                // Draw Grid
                ctx.strokeStyle = '#222';
                for(let i=0; i<800; i+=TILE_SIZE) { ctx.beginPath(); ctx.moveTo(i,0); ctx.lineTo(i,600); ctx.stroke(); }
                for(let i=0; i<600; i+=TILE_SIZE) { ctx.beginPath(); ctx.moveTo(0,i); ctx.lineTo(800,i); ctx.stroke(); }
                drawLevel(levels[currentLevelIndex]);
                ctx.fillStyle = 'white'; ctx.fillText("EDITOR MODE - CLICK TO PLACE - Q TO EXIT", 400, 50);
            }
        } else if (gameState === 'PLAYING') {
            updatePhysics();
            drawLevel(levels[currentLevelIndex]);
            ctx.fillStyle = CONFIG.colors.player;
            ctx.fillRect(player.x, player.y, player.w, player.h);
        }
        requestAnimationFrame(draw);
    }

    function drawLevel(level) {
        level.forEach(b => {
            ctx.fillStyle = b[4] === 2 ? CONFIG.colors.platform : (b[4] === 3 ? CONFIG.colors.goal : CONFIG.colors.hazard);
            ctx.fillRect(b[0], b[1], b[2], b[3]);
        });
    }

    function updatePhysics() {
        player.vy += CONFIG.physics.gravity;
        player.x += player.vx; player.y += player.vy;
        if (player.y > 600) { player.deaths++; resetLevel(); }
        // Simple floor collision
        if (player.y > 540) { player.y = 540; player.vy = 0; }
    }

    draw();
</script>
</body>
</html>
